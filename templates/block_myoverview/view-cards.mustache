{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template block_myoverview/view-cards

    ALIFE theme override - custom card view with circular progress and number badge
}}

<div class="card-grid mx-0 row row-cols-1 row-cols-sm-2 row-cols-lg-3" data-region="card-deck" role="list">
{{#courses}}
    <div class="col d-flex px-0 mb-2">
        <div class="coursebox clearfix" data-courseid="{{{id}}}" data-type="1" onclick="window.location.href='{{viewurl}}'" style="cursor: pointer;">
            <div class="courseimage-wrapper">
                <div class="courseimage">
                    <img src="{{{courseimage}}}" alt="{{fullname}}" class="w-100">
                </div>
                {{! Add circular progress indicator or caret }}
                {{#hasprogress}}
                    <div class="course-progress-circle" data-progress="{{progress}}" style="--progress: {{progress}};">
                        {{^progress}}00%{{/progress}}
                        {{#progress}}
                            {{progress}}%
                        {{/progress}}
                    </div>
                {{/hasprogress}}
                {{^hasprogress}}
                    <div class="course-caret-circle"></div>
                {{/hasprogress}}
            </div>
            <div class="info">
                {{! Number badge will be injected by JavaScript }}
                <h3 class="coursename">
                    <a href="{{viewurl}}">{{{shortname}}}</a>
                </h3>
            </div>
            <div class="content d-none"></div>
            {{! Keep the menu for actions }}
            <div class="course-action-menu">
                {{> block_myoverview/course-action-menu }}
            </div>
        </div>
    </div>
{{/courses}}
</div>

{{#js}}
require(['jquery', 'core/ajax'], function($, Ajax) {
    // Inject course numbers when courses are loaded
    function injectCourseNumbers() {
        $('.block-myoverview .coursebox[data-courseid]').each(function() {
            var $card = $(this);
            var courseId = $card.data('courseid');

            // Skip if already has number badge
            if ($card.find('.course-number-badge').length > 0) {
                return;
            }

            // Call web service to get the course number
            Ajax.call([{
                methodname: 'local_alife_get_course_number',
                args: {courseid: courseId}
            }])[0].done(function(courseNumber) {
                if (courseNumber) {
                    // Find the info section and prepend the badge (same as frontpage)
                    $card.find('.info').first().prepend(
                        '<div class="course-number-badge">' + courseNumber + '</div>'
                    );
                }
            }).fail(function(ex) {
                window.console.error('Failed to get course number for course ' + courseId + ': ' + ex.message);
            });
        });
    }

    // Prevent card click when clicking on action menu
    $(document).on('click', '.block-myoverview .course-action-menu, .block-myoverview .course-action-menu *', function(e) {
        e.stopPropagation();
    });

    // Try immediately
    $(document).ready(function() {
        setTimeout(injectCourseNumbers, 500);
        setTimeout(injectCourseNumbers, 1500);
    });

    // Also watch for new courses being loaded
    var observer = new MutationObserver(function() {
        injectCourseNumbers();
    });

    var target = document.querySelector('.block-myoverview');
    if (target) {
        observer.observe(target, {
            childList: true,
            subtree: true
        });
    }
});
{{/js}}
